<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBS â€“ Staff</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body class="portal">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">TBS Portal</div>
      <nav class="nav">
        <a href="/portal/dashboard.html" data-nav="dashboard">TBS Dashboard</a>
        <a href="/portal/calendar.html" data-nav="calendar">TBS Calendar</a>
        <a href="/portal/staff.html" data-nav="staff">TBS Staff</a>
        <a href="/portal/contractors.html" data-nav="contractors">TBS Contractors</a>
        <a href="/portal/projects.html" data-nav="projects">TBS Projects</a>
        <a href="/portal/warehouse.html" data-nav="warehouse">TBS Warehouse</a>
        <a href="/portal/finance.html" data-nav="finance">TBS Finance</a>
      </nav>
    </aside>

    <div class="content">
      <header class="dash-header">
        <div class="header-logo">
          <img src="../assets/TBSLogo.png" alt="TBS Logo">
          <h1>TBS Staff</h1>
        </div>
      </header>
      <div class="burger-menu" id="burgerMenu">
        <span></span>
        <span></span>
        <span></span>
      </div>

      <main id="dash" class="dash-grid">
        <!-- Staff Management Header -->
        <section class="panel staff-header">
          <h3>Staff Management</h3>
          <p>Manage team members, schedules, and assignments</p>
        </section>

        <!-- Staff Profile Cards -->
        <section class="panel staff-profiles">
          <div id="staffContainer" class="staff-grid">
            <!-- Staff cards will be populated dynamically from API -->
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="panel quick-actions">
          <h3>Quick Actions</h3>
          <div class="action-grid">
            <button class="quick-action-btn" onclick="addNewStaff()">
              <span class="action-icon">ðŸ‘¤</span>
              <span>Add Staff Member</span>
            </button>
            <button class="quick-action-btn" onclick="viewAllSchedules()">
              <span class="action-icon">ðŸ“…</span>
              <span>View All Schedules</span>
            </button>
            <button class="quick-action-btn" onclick="generatePayroll()">
              <span class="action-icon">ðŸ’°</span>
              <span>Generate Payroll</span>
            </button>
            <button class="quick-action-btn" onclick="exportStaffData()">
              <span class="action-icon">ðŸ“Š</span>
              <span>Export Data</span>
            </button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Bottom Staff Management Panel -->
  <div class="bottom-staff-panel">
    <div class="staff-management-controls">
      <button class="staff-management-btn" onclick="toggleStaffDropdown()">
        <span class="management-icon">ðŸ‘¥</span>
        <span class="management-text">Staff Management</span>
        <span class="dropdown-arrow">â–¼</span>
      </button>
      
      <div class="staff-dropdown" id="staffDropdown">
        <div class="dropdown-header">
          <h4>Manage Staff Members</h4>
          <button class="close-dropdown" onclick="closeStaffDropdown()">&times;</button>
        </div>
        
        <div class="dropdown-content">
          <div class="staff-list" id="staffList">
            <!-- Staff members will be populated here -->
          </div>
          
          <div class="dropdown-actions">
            <button class="dropdown-action-btn primary" onclick="addNewStaff()">
              <span class="action-icon">âž•</span>
              Add New Staff
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Staff Modal -->
  <div id="addStaffModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Staff Member</h3>
        <button class="modal-close" onclick="closeAddStaffModal()">&times;</button>
      </div>
      <form id="addStaffForm" class="modal-body" method="POST" onsubmit="return false;">
        <div class="form-group">
          <label for="staffName">Full Name</label>
          <input type="text" id="staffName" name="name" autocomplete="name" required placeholder="Enter full name">
        </div>
        <div class="form-group">
          <label for="staffEmail">Email Address</label>
          <input type="email" id="staffEmail" name="email" autocomplete="email" required placeholder="Enter email address">
        </div>
        <div class="form-group">
          <label for="staffPhone">Phone Number</label>
          <input type="tel" id="staffPhone" name="phone" autocomplete="tel" placeholder="Enter phone number">
        </div>
        <div class="form-group">
          <label for="staffRole">Role</label>
          <select id="staffRole" name="role" required>
            <option value="">Select a role</option>
            <option value="admin">Admin</option>
            <option value="foreman">Foreman</option>
            <option value="worker">Worker</option>
            <option value="contractor">Contractor</option>
            <option value="labourer">Labourer</option>
          </select>
        </div>
        <div class="form-group">
          <label for="staffPosition">Position Title</label>
          <input type="text" id="staffPosition" name="position" required placeholder="Enter position title">
        </div>
        <div class="form-group">
          <label for="staffPassword">Initial Password</label>
          <input type="password" id="staffPassword" name="password" required placeholder="Enter initial password">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddStaffModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitStaffForm()">Add Staff Member</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Remove Staff Confirmation Modal -->
  <div id="removeStaffModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Remove Staff Member</h3>
        <button class="modal-close" onclick="closeRemoveStaffModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="removeStaffName"></strong> from the team?</p>
        <p class="warning-text">This action cannot be undone and will remove all associated data.</p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeRemoveStaffModal()">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="confirmRemoveStaff()">Remove Staff Member</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./app.js" type="module"></script>
  <script>
    // Global function for adding new staff member
    function addNewStaff() {
      // Get the modal element
      const modal = document.getElementById('addStaffModal');
      if (modal) {
        modal.style.display = 'block';
        // Focus on the first input field
        const firstInput = modal.querySelector('input');
        if (firstInput) {
          firstInput.focus();
        }
      } else {
        console.error('Add staff modal not found');
      }
    }

    // Global function for closing modals
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        // Clear form if it's the add staff modal
        if (modalId === 'addStaffModal') {
          const form = modal.querySelector('form');
          if (form) {
            form.reset();
          }
        }
      }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const addStaffModal = document.getElementById('addStaffModal');
      const removeStaffModal = document.getElementById('removeStaffModal');
      
      if (event.target === addStaffModal) {
        addStaffModal.style.display = 'none';
      }
      if (event.target === removeStaffModal) {
        removeStaffModal.style.display = 'none';
      }
    }

    // Global function for staff dropdown
    window.toggleStaffDropdown = () => {
      const dropdown = document.getElementById('staffDropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      }
    };

    // Global function for closing add staff modal
    window.closeAddStaffModal = () => {
      const modal = document.getElementById('addStaffModal');
      if (modal) {
        modal.style.display = 'none';
        // Clear the form
        const form = document.getElementById('addStaffForm');
        if (form) {
          form.reset();
        }
      }
    };

    // Global function for closing remove staff modal
    window.closeRemoveStaffModal = () => {
      const modal = document.getElementById('removeStaffModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Global function for submitting staff form
    window.submitStaffForm = async () => {
      const form = document.getElementById('addStaffForm');
      if (!form) return;
      
      console.log('Staff form submitted via button click');
      
      const formData = new FormData(form);
      const staffData = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        role: formData.get('role'),
        position: formData.get('position'),
        password: formData.get('password')
      };
      
      console.log('Staff data to submit:', staffData);
      
      // Validate required fields
      if (!staffData.name || !staffData.email || !staffData.role || !staffData.position || !staffData.password) {
        alert('Please fill in all required fields');
        return;
      }
      
      try {
        const res = await fetch('https://tbs-production-9ec7.up.railway.app/api/staff', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tbs_at') || ''}`
          },
          body: JSON.stringify(staffData)
        });
        
        if (res.ok) {
          const newStaff = await res.json();
          console.log('Staff created successfully:', newStaff);
          
          // Show success message and close modal
          alert('Staff member added successfully!');
          closeAddStaffModal();
          
          // Refresh staff list to show the new staff member
          try {
            const res = await fetch('https://tbs-production-9ec7.up.railway.app/api/staff', {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('tbs_at') || ''}`
              }
            });
            const staff = await res.json();
            populateStaffCards(staff);
          } catch (err) {
            console.error('Error refreshing staff list:', err);
            // Fallback to page reload
            location.reload();
          }
        } else {
          const error = await res.json().catch(() => ({}));
          console.error('Staff creation failed:', {
            status: res.status,
            statusText: res.statusText,
            error: error
          });
          alert(`Error adding staff: ${error.error || `HTTP ${res.status}: ${res.statusText}`}`);
        }
      } catch (err) {
        console.error('Error adding staff:', err);
        alert('Error adding staff member. Please try again.');
      }
    };
  </script>
</body>
</html>
